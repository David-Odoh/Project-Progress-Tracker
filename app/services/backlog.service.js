"use strict";
//angular imports
var core_1 = require("@angular/core");
var Rx_1 = require("rxjs/Rx");
//3rd party imports
var _ = require("lodash");
//app imports
var _1 = require("./");
var mock_data_service_1 = require("./mock-data.service");
var static_data_1 = require("../shared/static-data");
var BacklogService = (function () {
    function BacklogService(mockDataService, userService, authService, zone) {
        var _this = this;
        this.mockDataService = mockDataService;
        this.userService = userService;
        this.authService = authService;
        this.zone = zone;
        this._genetatedItems = [];
        this._allItems = [];
        this._filteredItems = [];
        this._genetatedItems = this.mockDataService.generatePTItems(this.userService.users);
        this._itemsSubj = new Rx_1.BehaviorSubject([]);
        _.forEach(this._genetatedItems, function (item) {
            _this._allItems.push(item);
        });
        this._filterState = { filterViewIndex: 0 };
        this.publishUpdates();
        this._itemsObs = Rx_1.Observable.create(function (observer) {
            _this._observer = observer;
            observer.next(_this._allItems);
        });
    }
    Object.defineProperty(BacklogService.prototype, "itemsSubj", {
        get: function () {
            return this._itemsSubj;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BacklogService.prototype, "items", {
        get: function () {
            return this._genetatedItems;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(BacklogService.prototype, "ptItemsObs", {
        get: function () {
            return this._itemsObs;
        },
        enumerable: true,
        configurable: true
    });
    BacklogService.prototype.getItem = function (id) {
        var selectedItem = _.find(this._allItems, function (i) { return i.id == id; });
        return Promise.resolve(selectedItem);
    };
    BacklogService.prototype.addNewPTItem = function (newItem, assignee) {
        var item = {
            id: _.uniqueId(),
            title: newItem.title,
            description: newItem.description,
            type: newItem.type,
            estimate: 0,
            priority: static_data_1.PriorityEnum.Medium,
            status: static_data_1.StatusEnum.Open,
            assignee: assignee,
            tasks: [],
            comments: [],
            dateCreated: new Date(),
            dateModified: new Date()
        };
        this.addItem(item);
    };
    BacklogService.prototype.addItem = function (item) {
        this._allItems.unshift(item);
        this._observer.next(this._allItems);
        this.publishUpdates();
    };
    BacklogService.prototype.deleteItem = function (item) {
        _.remove(this._allItems, function (ptitem) { return ptitem.id === item.id; });
        this.publishUpdates();
    };
    BacklogService.prototype.toggleTask = function (item, task) {
        var index = _.indexOf(item.tasks, task);
        task.completed = !task.completed;
        item.tasks.splice(index, 1, task);
    };
    BacklogService.prototype.updateTask = function (item, task, newTitle) {
        var index = _.indexOf(item.tasks, task);
        task.title = newTitle;
        item.tasks.splice(index, 1, task);
    };
    BacklogService.prototype.addTask = function (item, newTask) {
        var task = {
            id: _.uniqueId(),
            title: newTask.title,
            completed: newTask.completed,
            dateCreated: new Date(),
            dateModified: new Date()
        };
        item.tasks.unshift(task);
    };
    BacklogService.prototype.addComment = function (item, newComment) {
        var comment = {
            id: _.uniqueId(),
            title: newComment.title,
            user: _.find(this.userService.users, function (user) { return user.id === newComment.userId; }),
            dateCreated: new Date(),
            dateModified: new Date()
        };
        item.comments.unshift(comment);
    };
    BacklogService.prototype.updatePtItem = function (item) {
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemEstimate = function (item, incdec) {
        if (item.estimate === 0 && !incdec)
            return;
        item.estimate = incdec ? item.estimate + 1 : item.estimate - 1;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemPriority = function (item, incdec) {
        if (static_data_1.PriorityEnum.isMax(item.priority) && incdec)
            return;
        if (static_data_1.PriorityEnum.isMin(item.priority) && !incdec)
            return;
        if (incdec) {
            item.priority = static_data_1.PriorityEnum.nextPriority(item.priority);
        }
        else {
            item.priority = static_data_1.PriorityEnum.previousPriority(item.priority);
        }
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemType = function (item, newType) {
        item.type = newType;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemAssignee = function (item, user) {
        item.assignee = user;
        this.publishUpdates();
    };
    BacklogService.prototype.updatePtItemStatus = function (item, newStatusStr) {
        var newStatus = static_data_1.StatusEnum[newStatusStr];
        if (item.status != newStatus) {
            item.status = newStatus;
            this.publishUpdates();
        }
    };
    BacklogService.prototype.switchAssignee = function (item) {
        var ranUser = _.sample(this.userService.users);
        item.assignee = ranUser;
        this.publishUpdates();
    };
    BacklogService.prototype.filter = function (filterState) {
        this._filterState = filterState;
        this.publishUpdates();
    };
    BacklogService.prototype.publishUpdates = function () {
        var _this = this;
        var filteredItems = [];
        switch (this._filterState.filterViewIndex) {
            case 0:
                filteredItems = this._allItems.filter(function (i) { return i.assignee.id === _this.authService.currentUser.id; });
                break;
            case 1:
                filteredItems = this._allItems.filter(function (i) { return i.status === static_data_1.StatusEnum.Open || i.status === static_data_1.StatusEnum.ReOpened; });
                break;
            case 2:
                filteredItems = this._allItems.filter(function (i) { return i.status === static_data_1.StatusEnum.Closed; });
                break;
            default:
                filteredItems = this._allItems;
        }
        // Make sure all updates are published inside NgZone so that change detection is triggered if needed
        this.zone.run(function () {
            // must emit a *new* value (immutability!)
            _this.itemsSubj.next(filteredItems.slice());
        });
    };
    return BacklogService;
}());
BacklogService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [mock_data_service_1.MockDataService,
        _1.UserService,
        _1.AuthenticationService,
        core_1.NgZone])
], BacklogService);
exports.BacklogService = BacklogService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2xvZy5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYmFja2xvZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxpQkFBaUI7QUFDakIsc0NBQTJEO0FBQzNELDhCQUFnRTtBQUVoRSxtQkFBbUI7QUFDbkIsMEJBQTRCO0FBRTVCLGFBQWE7QUFDYix1QkFBd0Q7QUFDeEQseURBQXNEO0FBR3RELHFEQUErRTtBQVcvRSxJQUFhLGNBQWM7SUFzQnZCLHdCQUFvQixlQUFnQyxFQUN4QyxXQUF3QixFQUN4QixXQUFrQyxFQUNsQyxJQUFZO1FBSHhCLGlCQW9CQztRQXBCbUIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBQ3hDLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLGdCQUFXLEdBQVgsV0FBVyxDQUF1QjtRQUNsQyxTQUFJLEdBQUosSUFBSSxDQUFRO1FBdkJoQixvQkFBZSxHQUFtQixFQUFFLENBQUM7UUFLckMsY0FBUyxHQUFtQixFQUFFLENBQUM7UUFDL0IsbUJBQWMsR0FBbUIsRUFBRSxDQUFDO1FBa0J4QyxJQUFJLENBQUMsZUFBZSxHQUFHLElBQUksQ0FBQyxlQUFlLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFcEYsSUFBSSxDQUFDLFVBQVUsR0FBRyxJQUFJLG9CQUFlLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDMUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxFQUFFLFVBQUMsSUFBSTtZQUNqQyxLQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksQ0FBQyxZQUFZLEdBQUcsRUFBRSxlQUFlLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFFM0MsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBR3RCLElBQUksQ0FBQyxTQUFTLEdBQUcsZUFBVSxD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Z0JBQ0YsYUFBYSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLFVBQUEsQ0FBQyxJQUFJLE9BQUEsQ0FBQyxDQUFDLE1BQU0sS0FBSyx3QkFBVSxDQUFDLElBQUksSUFBSSxDQUFDLENBQUMsTUFBTSxLQUFLLHdCQUFVLENBQUMsUUFBUSxFQUFoRSxDQUFnRSxDQUFDLENBQUM7Z0JBQzdHLEtBQUssQ0FBQztZQUNWLEtBQUssQ0FBQztnQkFDRixhQUFhLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsVUFBQSxDQUFDLElBQUksT0FBQSxDQUFDLENBQUMsTUFBTSxLQUFLLHdCQUFVLENBQUMsTUFBTSxFQUE5QixDQUE4QixDQUFDLENBQUM7Z0JBQzNFLEtBQUssQ0FBQztZQUNWO2dCQUNJLGFBQWEsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO1FBQ3ZDLENBQUM7UUFFRCxvR0FBb0c7UUFDcEcsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7WUFDViwwQ0FBMEM7WUFDMUMsS0FBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUssYUFBYSxTQUFFLENBQUM7UUFDNUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBQ0wscUJBQUM7QUFBRCxDQUFDLEFBMUxELElBMExDO0FBMUxZLGNBQWM7SUFEMUIsaUJBQVUsRUFBRTtxQ0F1QjRCLG1DQUFlO1FBQzNCLGNBQVc7UUFDWCx3QkFBcUI7UUFDNUIsYUFBTTtHQXpCZixjQUFjLENBMEwxQjtBQTFMWSx3Q0FBYyIsInNvdXJjZXNDb250ZW50IjpbIi8vYW5ndWxhciBpbXBvcnRzXG5pbXBvcnQgeyBJbmplY3RhYmxlLCBPbkluaXQsIE5nWm9uZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgT2JzZXJ2ZXIsIEJlaGF2aW9yU3ViamVjdCB9IGZyb20gXCJyeGpzL1J4XCI7XG5cbi8vM3JkIHBhcnR5IGltcG9ydHNcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcblxuLy9hcHAgaW1wb3J0c1xuaW1wb3J0IHsgQXV0aGVudGljYXRpb25TZXJ2aWNlLCBVc2VyU2VydmljZSB9IGZyb20gJy4vJztcbmltcG9ydCB7IE1vY2tEYXRhU2VydmljZSB9IGZyb20gJy4vbW9jay1kYXRhLnNlcnZpY2UnO1xuaW1wb3J0IHsgRmlsdGVyU3RhdGUgfSBmcm9tICcuLi9zaGFyZWQvZmlsdGVyLXN0YXRlLm1vZGVsJztcbmltcG9ydCB7IFBURG9tYWluIH0gZnJvbSAnLi4vdHlwaW5ncy9kb21haW4nO1xuaW1wb3J0IHsgSXRlbVR5cGVFbnVtLCBQcmlvcml0eUVudW0sIFN0YXR1c0VudW0gfSBmcm9tICcuLi9zaGFyZWQvc3RhdGljLWRhdGEnO1xuaW1wb3J0IElVc2VyID0gUFREb21haW4uSVVzZXI7XG5pbXBvcnQgSVBUSXRlbSA9IFBURG9tYWluLklQVEl0ZW07XG5pbXBvcnQgSVRhc2sgPSBQVERvbWFpbi5JVGFzaztcbmltcG9ydCBJQ29tbWVudCA9IFBURG9tYWluLklDb21tZW50O1xuaW1wb3J0IElOZXdJdGVtID0gUFREb21haW4uSU5ld0l0ZW07XG5pbXBvcnQgSU5ld1Rhc2sgPSBQVERvbWFpbi5JTmV3VGFzaztcbmltcG9ydCBJTmV3Q29tbWVudCA9IFBURG9tYWluLklOZXdDb21tZW50O1xuXG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCYWNrbG9nU2VydmljZSB7XG5cbiAgICBwcml2YXRlIF9nZW5ldGF0ZWRJdGVtczogQXJyYXk8SVBUSXRlbT4gPSBbXTtcbiAgICBwcml2YXRlIF9pdGVtc09iczogT2JzZXJ2YWJsZTxBcnJheTxJUFRJdGVtPj47XG4gICAgcHJpdmF0ZSBfaXRlbXNTdWJqOiBCZWhhdmlvclN1YmplY3Q8QXJyYXk8SVBUSXRlbT4+O1xuICAgIHByaXZhdGUgX29ic2VydmVyOiBPYnNlcnZlcjxBcnJheTxJUFRJdGVtPj47XG4gICAgcHJpdmF0ZSBfZmlsdGVyU3RhdGU6IEZpbHRlclN0YXRlO1xuICAgIHByaXZhdGUgX2FsbEl0ZW1zOiBBcnJheTxJUFRJdGVtPiA9IFtdO1xuICAgIHByaXZhdGUgX2ZpbHRlcmVkSXRlbXM6IEFycmF5PElQVEl0ZW0+ID0gW107XG5cbiAgICBwdWJsaWMgZ2V0IGl0ZW1zU3ViaigpOiBCZWhhdmlvclN1YmplY3Q8QXJyYXk8SVBUSXRlbT4+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2l0ZW1zU3ViajtcbiAgICB9XG5cbiAgICBwdWJsaWMgZ2V0IGl0ZW1zKCk6IEFycmF5PElQVEl0ZW0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX2dlbmV0YXRlZEl0ZW1zO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgcHRJdGVtc09icygpOiBPYnNlcnZhYmxlPEFycmF5PElQVEl0ZW0+PiB7XG4gICAgICAgIHJldHVybiB0aGlzLl9pdGVtc09icztcbiAgICB9XG5cbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIG1vY2tEYXRhU2VydmljZTogTW9ja0RhdGFTZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHVzZXJTZXJ2aWNlOiBVc2VyU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBhdXRoU2VydmljZTogQXV0aGVudGljYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIHpvbmU6IE5nWm9uZSkge1xuICAgICAgICB0aGlzLl9nZW5ldGF0ZWRJdGVtcyA9IHRoaXMubW9ja0RhdGFTZXJ2aWNlLmdlbmVyYXRlUFRJdGVtcyh0aGlzLnVzZXJTZXJ2aWNlLnVzZXJzKTtcblxuICAgICAgICB0aGlzLl9pdGVtc1N1YmogPSBuZXcgQmVoYXZpb3JTdWJqZWN0KFtdKTtcbiAgICAgICAgXy5mb3JFYWNoKHRoaXMuX2dlbmV0YXRlZEl0ZW1zLCAoaXRlbSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5fYWxsSXRlbXMucHVzaChpdGVtKTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5fZmlsdGVyU3RhdGUgPSB7IGZpbHRlclZpZXdJbmRleDogMCB9O1xuXG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcblxuXG4gICAgICAgIHRoaXMuX2l0ZW1zT2JzID0gT2JzZXJ2YWJsZS5jcmVhdGUoKG9ic2VydmVyOiBPYnNlcnZlcjxBcnJheTxJUFRJdGVtPj4pID0+IHtcbiAgICAgICAgICAgIHRoaXMuX29ic2VydmVyID0gb2JzZXJ2ZXI7XG4gICAgICAgICAgICBvYnNlcnZlci5uZXh0KHRoaXMuX2FsbEl0ZW1zKTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgZ2V0SXRlbShpZDogc3RyaW5nKSB7XG4gICAgICAgIGxldCBzZWxlY3RlZEl0ZW0gPSBfLmZpbmQodGhpcy5fYWxsSXRlbXMsIGkgPT4gaS5pZCA9PSBpZCk7XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoc2VsZWN0ZWRJdGVtKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkTmV3UFRJdGVtKG5ld0l0ZW06IElOZXdJdGVtLCBhc3NpZ25lZTogSVVzZXIpIHtcbiAgICAgICAgbGV0IGl0ZW06IElQVEl0ZW0gPSB7XG4gICAgICAgICAgICBpZDogXy51bmlxdWVJZCgpLFxuICAgICAgICAgICAgdGl0bGU6IG5ld0l0ZW0udGl0bGUsXG4gICAgICAgICAgICBkZXNjcmlwdGlvbjogbmV3SXRlbS5kZXNjcmlwdGlvbixcbiAgICAgICAgICAgIHR5cGU6IG5ld0l0ZW0udHlwZSxcbiAgICAgICAgICAgIGVzdGltYXRlOiAwLFxuICAgICAgICAgICAgcHJpb3JpdHk6IFByaW9yaXR5RW51bS5NZWRpdW0sXG4gICAgICAgICAgICBzdGF0dXM6IFN0YXR1c0VudW0uT3BlbixcbiAgICAgICAgICAgIGFzc2lnbmVlOiBhc3NpZ25lZSxcbiAgICAgICAgICAgIHRhc2tzOiBbXSxcbiAgICAgICAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgICAgICAgIGRhdGVDcmVhdGVkOiBuZXcgRGF0ZSgpLFxuICAgICAgICAgICAgZGF0ZU1vZGlmaWVkOiBuZXcgRGF0ZSgpXG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuYWRkSXRlbShpdGVtKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgYWRkSXRlbShpdGVtOiBJUFRJdGVtKSB7XG4gICAgICAgIHRoaXMuX2FsbEl0ZW1zLnVuc2hpZnQoaXRlbSk7XG4gICAgICAgIHRoaXMuX29ic2VydmVyLm5leHQodGhpcy5fYWxsSXRlbXMpO1xuICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlbGV0ZUl0ZW0oaXRlbTogSVBUSXRlbSkge1xuICAgICAgICBfLnJlbW92ZSh0aGlzLl9hbGxJdGVtcywgKHB0aXRlbSkgPT4gcHRpdGVtLmlkID09PSBpdGVtLmlkKTtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB0b2dnbGVUYXNrKGl0ZW06IElQVEl0ZW0sIHRhc2s6IElUYXNrKSB7XG4gICAgICAgIHZhciBpbmRleCA9IF8uaW5kZXhPZihpdGVtLnRhc2tzLCB0YXNrKTtcbiAgICAgICAgdGFzay5jb21wbGV0ZWQgPSAhdGFzay5jb21wbGV0ZWQ7XG4gICAgICAgIGl0ZW0udGFza3Muc3BsaWNlKGluZGV4LCAxLCB0YXNrKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlVGFzayhpdGVtOiBJUFRJdGVtLCB0YXNrOiBJVGFzaywgbmV3VGl0bGU6IHN0cmluZykge1xuICAgICAgICB2YXIgaW5kZXggPSBfLmluZGV4T2YoaXRlbS50YXNrcywgdGFzayk7XG4gICAgICAgIHRhc2sudGl0bGUgPSBuZXdUaXRsZTtcbiAgICAgICAgaXRlbS50YXNrcy5zcGxpY2UoaW5kZXgsIDEsIHRhc2spO1xuICAgIH1cblxuICAgIHB1YmxpYyBhZGRUYXNrKGl0ZW06IElQVEl0ZW0sIG5ld1Rhc2s6IElOZXdUYXNrKSB7XG4gICAgICAgIHZhciB0YXNrOiBJVGFzayA9IHtcbiAgICAgICAgICAgIGlkOiBfLnVuaXF1ZUlkKCksXG4gICAgICAgICAgICB0aXRsZTogbmV3VGFzay50aXRsZSxcbiAgICAgICAgICAgIGNvbXBsZXRlZDogbmV3VGFzay5jb21wbGV0ZWQsXG4gICAgICAgICAgICBkYXRlQ3JlYXRlZDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIGRhdGVNb2RpZmllZDogbmV3IERhdGUoKVxuICAgICAgICB9O1xuICAgICAgICBpdGVtLnRhc2tzLnVuc2hpZnQodGFzayk7XG4gICAgfVxuXG4gICAgcHVibGljIGFkZENvbW1lbnQoaXRlbTogSVBUSXRlbSwgbmV3Q29tbWVudDogSU5ld0NvbW1lbnQpIHtcbiAgICAgICAgdmFyIGNvbW1lbnQ6IElDb21tZW50ID0ge1xuICAgICAgICAgICAgaWQ6IF8udW5pcXVlSWQoKSxcbiAgICAgICAgICAgIHRpdGxlOiBuZXdDb21tZW50LnRpdGxlLFxuICAgICAgICAgICAgdXNlcjogXy5maW5kKHRoaXMudXNlclNlcnZpY2UudXNlcnMsICh1c2VyKSA9PiB1c2VyLmlkID09PSBuZXdDb21tZW50LnVzZXJJZCksXG4gICAgICAgICAgICBkYXRlQ3JlYXRlZDogbmV3IERhdGUoKSxcbiAgICAgICAgICAgIGRhdGVNb2RpZmllZDogbmV3IERhdGUoKVxuICAgICAgICB9O1xuICAgICAgICBpdGVtLmNvbW1lbnRzLnVuc2hpZnQoY29tbWVudCk7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZVB0SXRlbShpdGVtOiBJUFRJdGVtKSB7XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlUHRJdGVtRXN0aW1hdGUoaXRlbTogSVBUSXRlbSwgaW5jZGVjOiBib29sZWFuKSB7XG4gICAgICAgIGlmIChpdGVtLmVzdGltYXRlID09PSAwICYmICFpbmNkZWMpIHJldHVybjtcbiAgICAgICAgaXRlbS5lc3RpbWF0ZSA9IGluY2RlYyA/IGl0ZW0uZXN0aW1hdGUgKyAxIDogaXRlbS5lc3RpbWF0ZSAtIDE7XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlUHRJdGVtUHJpb3JpdHkoaXRlbTogSVBUSXRlbSwgaW5jZGVjOiBib29sZWFuKSB7XG4gICAgICAgIGlmIChQcmlvcml0eUVudW0uaXNNYXgoaXRlbS5wcmlvcml0eSkgJiYgaW5jZGVjKSByZXR1cm47XG4gICAgICAgIGlmIChQcmlvcml0eUVudW0uaXNNaW4oaXRlbS5wcmlvcml0eSkgJiYgIWluY2RlYykgcmV0dXJuO1xuXG4gICAgICAgIGlmIChpbmNkZWMpIHtcbiAgICAgICAgICAgIGl0ZW0ucHJpb3JpdHkgPSBQcmlvcml0eUVudW0ubmV4dFByaW9yaXR5KGl0ZW0ucHJpb3JpdHkpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaXRlbS5wcmlvcml0eSA9IFByaW9yaXR5RW51bS5wcmV2aW91c1ByaW9yaXR5KGl0ZW0ucHJpb3JpdHkpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgdXBkYXRlUHRJdGVtVHlwZShpdGVtOiBJUFRJdGVtLCBuZXdUeXBlOiBJdGVtVHlwZUVudW0pIHtcbiAgICAgICAgaXRlbS50eXBlID0gbmV3VHlwZTtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQdEl0ZW1Bc3NpZ25lZShpdGVtOiBJUFRJdGVtLCB1c2VyOiBJVXNlcikge1xuICAgICAgICBpdGVtLmFzc2lnbmVlID0gdXNlcjtcbiAgICAgICAgdGhpcy5wdWJsaXNoVXBkYXRlcygpO1xuICAgIH1cblxuICAgIHB1YmxpYyB1cGRhdGVQdEl0ZW1TdGF0dXMoaXRlbTogSVBUSXRlbSwgbmV3U3RhdHVzU3RyOiBzdHJpbmcpIHtcbiAgICAgICAgbGV0IG5ld1N0YXR1cyA9IFN0YXR1c0VudW1bbmV3U3RhdHVzU3RyXTtcbiAgICAgICAgaWYgKGl0ZW0uc3RhdHVzICE9IG5ld1N0YXR1cykge1xuICAgICAgICAgICAgaXRlbS5zdGF0dXMgPSBuZXdTdGF0dXM7XG4gICAgICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwdWJsaWMgc3dpdGNoQXNzaWduZWUoaXRlbTogSVBUSXRlbSkge1xuICAgICAgICBsZXQgcmFuVXNlciA9IF8uc2FtcGxlPElVc2VyPih0aGlzLnVzZXJTZXJ2aWNlLnVzZXJzKTtcbiAgICAgICAgaXRlbS5hc3NpZ25lZSA9IHJhblVzZXI7XG4gICAgICAgIHRoaXMucHVibGlzaFVwZGF0ZXMoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgZmlsdGVyKGZpbHRlclN0YXRlOiBGaWx0ZXJTdGF0ZSkge1xuICAgICAgICB0aGlzLl9maWx0ZXJTdGF0ZSA9IGZpbHRlclN0YXRlO1xuICAgICAgICB0aGlzLnB1Ymxpc2hVcGRhdGVzKCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBwdWJsaXNoVXBkYXRlcygpIHtcbiAgICAgICAgdmFyIGZpbHRlcmVkSXRlbXMgPSBbXTtcbiAgICAgICAgc3dpdGNoICh0aGlzLl9maWx0ZXJTdGF0ZS5maWx0ZXJWaWV3SW5kZXgpIHtcbiAgICAgICAgICAgIGNhc2UgMDpcbiAgICAgICAgICAgICAgICBmaWx0ZXJlZEl0ZW1zID0gdGhpcy5fYWxsSXRlbXMuZmlsdGVyKGkgPT4gaS5hc3NpZ25lZS5pZCA9PT0gdGhpcy5hdXRoU2VydmljZS5jdXJyZW50VXNlci5pZCk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIDE6XG4gICAgICAgICAgICAgICAgZmlsdGVyZWRJdGVtcyA9IHRoaXMuX2FsbEl0ZW1zLmZpbHRlcihpID0+IGkuc3RhdHVzID09PSBTdGF0dXNFbnVtLk9wZW4gfHwgaS5zdGF0dXMgPT09IFN0YXR1c0VudW0uUmVPcGVuZWQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSAyOlxuICAgICAgICAgICAgICAgIGZpbHRlcmVkSXRlbXMgPSB0aGlzLl9hbGxJdGVtcy5maWx0ZXIoaSA9PiBpLnN0YXR1cyA9PT0gU3RhdHVzRW51bS5DbG9zZWQpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICAgICAgICBmaWx0ZXJlZEl0ZW1zID0gdGhpcy5fYWxsSXRlbXM7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBNYWtlIHN1cmUgYWxsIHVwZGF0ZXMgYXJlIHB1Ymxpc2hlZCBpbnNpZGUgTmdab25lIHNvIHRoYXQgY2hhbmdlIGRldGVjdGlvbiBpcyB0cmlnZ2VyZWQgaWYgbmVlZGVkXG4gICAgICAgIHRoaXMuem9uZS5ydW4oKCkgPT4ge1xuICAgICAgICAgICAgLy8gbXVzdCBlbWl0IGEgKm5ldyogdmFsdWUgKGltbXV0YWJpbGl0eSEpXG4gICAgICAgICAgICB0aGlzLml0ZW1zU3Viai5uZXh0KFsuLi5maWx0ZXJlZEl0ZW1zXSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn0iXX0=